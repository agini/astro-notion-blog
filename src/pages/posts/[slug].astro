---
import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'
import BlogPostsLink from '../../components/BlogPostsLink.astro'
import BlogTagsLink from '../../components/BlogTagsLink.astro'
import PostFeaturedImage from '../../components/PostFeaturedImage.astro'
import styles from '../../styles/blog.module.css'

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;
const slug = decodeURIComponent(Astro.params.slug);

export async function getStaticPaths() {
  const res = await fetch(API_BASE + "/posts");
  const data = await res.json();

  return data.results.map((post) => ({
    params: { slug: post.slug }
  }));
}

const listRes = await fetch(API_BASE + "/posts");
const listJson = await listRes.json();
const allPosts = listJson.results;

const post = allPosts.find((p) => p.slug === slug);
if (!post) {
  throw new Error("Post not found: slug=" + slug);
}

const detailRes = await fetch(API_BASE + "/post/" + post.id);
const detailJson = await detailRes.json();
const blocks = detailJson.blocks || [];

const ranked = await (await fetch(API_BASE + "/ranked-posts")).json();
const tags = await (await fetch(API_BASE + "/tags")).json();
const latest = await (await fetch(API_BASE + "/posts")).json();

const idx = allPosts.findIndex((p) => p.slug === slug);
const prevPost = allPosts[idx + 1] || null;
const nextPost = allPosts[idx - 1] || null;

const ogImage = post.featuredImage ?? "";
---
