---
console.log('API_BASE =', import.meta.env.PUBLIC_API_BASE_URL)
console.log('slug:', params.slug)
console.log('post:', post)

import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'
import BlogPostsLink from '../../components/BlogPostsLink.astro'
import BlogTagsLink from '../../components/BlogTagsLink.astro'
import PostFeaturedImage from '../../components/PostFeaturedImage.astro'
import styles from '../../styles/blog.module.css'

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL
const slug = Astro.params.slug

// ① slug で記事詳細を直接取得
const post = await fetch(`${API_BASE}/post-by-slug/${slug}`).then((r) =>
  r.json()
)

if (!post.id) {
  console.error('post-by-slug が記事を返しませんでした:', slug)
  throw new Error('Post not found: ' + slug)
}

// ② blocks
const blocks = Array.isArray(post.blocks) ? post.blocks : []

// ③ 一覧（前後記事計算用）
// ◎ 記事一覧の取得
const listJson = await fetch(`${API_BASE}/posts`).then((r) => r.json())
const allPosts = listJson.results

// 前後の記事
const idx = allPosts.findIndex((p) => p.slug === slug)
const prevPost = allPosts[idx + 1] || null
const nextPost = allPosts[idx - 1] || null

// ④ サイドバーデータ
const ranked = await fetch(`${API_BASE}/ranked-posts`).then((r) => r.json())
const tags = await fetch(`${API_BASE}/tags`).then((r) => r.json())
const latest = await fetch(`${API_BASE}/posts`).then((r) => r.json())

const ogImage = post.featuredImage ?? ''

export async function getStaticPaths() {
  const res = await fetch(API_BASE + '/posts')
  const data = await res.json()

  return data.results.map((post) => ({
    params: { slug: post.slug },
  }))
}
---
