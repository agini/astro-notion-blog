---
const NOTION_TOKEN = process.env.NOTION_API_KEY;
const DATABASE_ID = process.env.NOTION_DATABASE_ID;

import Layout from '../../layouts/Layout.astro';
import PostDate from '../../components/PostDate.astro';
import PostTags from '../../components/PostTags.astro';
import PostTitle from '../../components/PostTitle.astro';
import PostBody from '../../components/PostBody.astro';
import PostRelativeLink from '../../components/PostRelativeLink.astro';
import BlogPostsLink from '../../components/BlogPostsLink.astro';
import BlogTagsLink from '../../components/BlogTagsLink.astro';
import PostFeaturedImage from '../../components/PostFeaturedImage.astro';
import styles from '../../styles/blog.module.css';

const slug = Astro.params.slug;

export async function getStaticPaths() {
  const res = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}/query`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${NOTION_TOKEN}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ page_size: 100 }),
  });

  if (!res.ok) {
    const text = await res.text();
    console.error('Error fetching database:', res.status, text);
    throw new Error(`Failed to fetch Notion database: ${res.status}`);
  }

  const data = await res.json();

  return data.results.map((p) => ({
    params: { slug: p.properties.Slug.rich_text[0]?.text.content ?? '' },
  }));
}

async function getPostData(slug) {
  const queryRes = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}/query`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${NOTION_TOKEN}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      filter: { property: 'Slug', rich_text: { equals: slug } },
    }),
  });

  if (!queryRes.ok) {
    const text = await queryRes.text();
    console.error('Error fetching post by slug:', queryRes.status, text);
    throw new Error(`Failed to fetch post: ${queryRes.status}`);
  }

  const queryData = await queryRes.json();
  const post = queryData.results[0];
  if (!post) throw new Error('Post not found: ' + slug);

  const blocksRes = await fetch(`https://api.notion.com/v1/blocks/${post.id}/children`, {
    headers: {
      'Authorization': `Bearer ${NOTION_TOKEN}`,
      'Notion-Version': '2022-06-28',
    },
  });

  if (!blocksRes.ok) {
    const text = await blocksRes.text();
    console.error('Error fetching blocks:', blocksRes.status, text);
    throw new Error(`Failed to fetch blocks: ${blocksRes.status}`);
  }

  const blocksData = await blocksRes.json();

  const allPostsRes = await fetch(`https://api.notion.com/v1/databases/${DATABASE_ID}/query`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${NOTION_TOKEN}`,
      'Notion-Version': '2022-06-28',
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({ page_size: 100 }),
  });

  const allPostsData = await allPostsRes.json();
  const allPosts = allPostsData.results ?? [];

  const idx = allPosts.findIndex((p) => p.properties.Slug.rich_text[0]?.text.content === slug);
  const prevPost = allPosts[idx + 1] ?? null;
  const nextPost = allPosts[idx - 1] ?? null;

  return {
    post,
    blocks: blocksData.results ?? [],
    prevPost,
    nextPost,
    latest: allPosts,
    ogImage: post.cover?.external?.url ?? '',
  };
}

const { post, blocks, prevPost, nextPost, latest, ogImage } = await getPostData(slug);
---

<Layout title={post.properties.Title.title[0]?.text.content ?? ''} ogImage={ogImage}>
  <article class={styles.postContainer}>
    <PostTitle post={post} />
    <PostDate post={post} />
    <PostTags post={post} />
    <PostFeaturedImage post={post} />
    <PostBody blocks={blocks} />
    <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
  </article>

  <aside class={styles.sidebar}>
    <BlogPostsLink heading="Latest Posts" posts={latest ?? []} />
  </aside>
</Layout>
