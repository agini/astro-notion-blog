---
console.log('API_BASE =', import.meta.env.PUBLIC_API_BASE_URL);

import Layout from '../../layouts/Layout.astro';
import PostDate from '../../components/PostDate.astro';
import PostTags from '../../components/PostTags.astro';
import PostTitle from '../../components/PostTitle.astro';
import PostBody from '../../components/PostBody.astro';
import PostRelativeLink from '../../components/PostRelativeLink.astro';
import BlogPostsLink from '../../components/BlogPostsLink.astro';
import BlogTagsLink from '../../components/BlogTagsLink.astro';
import PostFeaturedImage from '../../components/PostFeaturedImage.astro';
import styles from '../../styles/blog.module.css';

/* --- paths --- */
export async function getStaticPaths() {
  const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;
  const res = await fetch(API_BASE + '/posts');
  const data = await res.json();

  return data.results.map((p) => ({
    params: { slug: p.slug },
  }));
}

/* --- slug --- */
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;
const slug = Astro.params.slug;

/* --- detail --- */
const detail = await fetch(API_BASE + '/post-by-slug/' + slug).then(r => r.json());
if (!detail.id) throw new Error('Post not found: ' + slug);
const post = detail;

/* --- blocks --- */
const blocks = Array.isArray(post.blocks) ? post.blocks : [];

/* --- prev/next --- */
const listJson = await fetch(API_BASE + '/posts').then(r => r.json());
const allPosts = listJson.results;
const getSlug = (p) => p?.slug ?? '';
const idx = allPosts.findIndex((p) => getSlug(p) === slug);
const prevPost = allPosts[idx + 1] || null;
const nextPost = allPosts[idx - 1] || null;

/* --- sidebar --- */
const ranked = await fetch(API_BASE + '/ranked-posts').then(r => r.json());
const tags = await fetch(API_BASE + '/tags').then(r => r.json());
const latest = await fetch(API_BASE + '/posts').then(r => r.json());

const ogImage = post.featuredImage ?? '';
---

<Layout title={post.title} ogImage={ogImage}>
  <article class={styles.postContainer}>
    <PostTitle post={post} />
    <PostDate post={post} />
    <PostTags post={post} />
    <PostFeaturedImage post={post} />
    <PostBody blocks={blocks} />
    <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
  </article>

  <aside class={styles.sidebar}>
    <BlogPostsLink heading="Latest Posts" posts={latest.results} />
    <BlogTagsLink heading="Tags" tags={tags} />
    <BlogPostsLink heading="Ranked Posts" posts={ranked.results} />
  </aside>
</Layout>
