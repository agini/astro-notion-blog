---
/* ⭐ これをファイルの最上部に1回だけ置く */
const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;

import * as interfaces from '../../lib/interfaces.ts'
import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'
import BlogPostsLink from '../../components/BlogPostsLink.astro'
import BlogTagsLink from '../../components/BlogTagsLink.astro'
import PostFeaturedImage from '../../components/PostFeaturedImage.astro'
import styles from '../../styles/blog.module.css'

/* --------------------------------------------------
 *  getStaticPaths：投稿スラッグの一覧
 * -------------------------------------------------- */
export async function getStaticPaths() {
  const res = await fetch(`${API_BASE}/posts`);
  const data = await res.json();

  return data.results.map((post) => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

/* --------------------------------------------------
 *  投稿本体
 * -------------------------------------------------- */
const listRes = await fetch(`${API_BASE}/posts`);
const listJson = await listRes.json();
const allPosts = listJson.results;

const post = allPosts.find((p) => p.slug === slug);
if (!post) {
  throw new Error(`Post not found: slug=${slug}`);
}

/* ブロック内容 */
const detailRes = await fetch(`${API_BASE}/post/${post.id}`);
const detailJson = await detailRes.json();
const blocks = detailJson.blocks || [];

/* その他情報 */
const ranked = await (await fetch(`${API_BASE}/ranked-posts`)).json();
const tags = await (await fetch(`${API_BASE}/tags`)).json();
const latest = await (await fetch(`${API_BASE}/posts`)).json();

/* Prev / Next */
const idx = allPosts.findIndex((p) => p.slug === slug);
const prevPost = allPosts[idx + 1] || null;
const nextPost = allPosts[idx - 1] || null;

const ogImage = post.featuredImage ?? "";
---

<Layout
  title={post.title}
  description={post.excerpt}
  ogImage={ogImage}
>
  <div slot="main" class={styles.main}>
    <div class={styles.post}>
      <PostDate post={post} />
      <PostTags post={post} />
      <PostTitle post={post} enableLink={false} />
      <PostFeaturedImage post={post} />

      <PostBody blocks={blocks} />

      <PostTags post={post} />

      <footer>
        <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
      </footer>
    </div>
  </div>

  <div slot="aside" class="aside">
    <BlogPostsLink heading="Posts in the same category" posts={ranked.results || []} />
    <BlogPostsLink heading="Latest posts" posts={latest.results || []} />
    <BlogTagsLink heading="Categories" tags={tags || []} />
  </div>
</Layout>
