---
import Layout from '../../layouts/Layout.astro'
import PostDate from '../../components/PostDate.astro'
import PostTags from '../../components/PostTags.astro'
import PostTitle from '../../components/PostTitle.astro'
import PostBody from '../../components/PostBody.astro'
import PostRelativeLink from '../../components/PostRelativeLink.astro'
import BlogPostsLink from '../../components/BlogPostsLink.astro'
import BlogTagsLink from '../../components/BlogTagsLink.astro'
import PostFeaturedImage from '../../components/PostFeaturedImage.astro'
import styles from '../../styles/blog.module.css'

const API_BASE = import.meta.env.PUBLIC_API_BASE_URL;

/* ---------------------------------------------
 * 1. getStaticPaths → Workers API /posts を使用
 * --------------------------------------------- */
export async function getStaticPaths() {
  const res = await fetch(`${API_BASE}/posts`);
  const data = await res.json();

  return data.results.map(post => ({
    params: { slug: post.slug },
  }));
}

const { slug } = Astro.params;

/* ---------------------------------------------------
 * 2. 記事一覧から対象 slug の投稿を取得
 * --------------------------------------------------- */
const listRes = await fetch(`${API_BASE}/posts`);
const listJson = await listRes.json();
const allPosts = listJson.results;

// 対象記事
const post = allPosts.find(p => p.slug === slug);
if (!post) throw new Error(`Post not found: slug=${slug}`);

/* ---------------------------------------------------
 * 3. Blocks を Workers API から取得
 *    /post/{pageId}
 * --------------------------------------------------- */
const detailRes = await fetch(`${API_BASE}/post/${post.id}`);
const detailJson = await detailRes.json();

const blocks = detailJson.blocks || [];

/* ---------------------------------------------------
 * 4. Recommended / Latest / Tags を Workers API から取得
 * --------------------------------------------------- */
const rankedRes = await fetch(`${API_BASE}/ranked-posts`);
const rankedJson = await rankedRes.json();

const tagsRes = await fetch(`${API_BASE}/tags`);
const tagsJson = await tagsRes.json();

const latestRes = await fetch(`${API_BASE}/posts`);
const latestJson = await latestRes.json();

/* ---------------------------------------------------
 * 5. Prev / Next 計算
 * --------------------------------------------------- */
const currentIndex = allPosts.findIndex(p => p.slug === slug);
const prevPost = allPosts[currentIndex + 1] || null;
const nextPost = allPosts[currentIndex - 1] || null;

/* ---------------------------------------------------
 * 6. OGP 対応（存在すれば使う）
 * --------------------------------------------------- */
const ogImage = post.featuredImage ?? "";
---

<Layout
  title={post.title}
  description={post.excerpt}
  ogImage={ogImage}
>
  <div slot="main" class={styles.main}>
    <div class={styles.post}>
      <PostDate post={post} />
      <PostTags post={post} />
      <PostTitle post={post} enableLink={false} />
      <PostFeaturedImage post={post} />

      <PostBody blocks={blocks} />

      <PostTags post={post} />

      <footer>
        <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
      </footer>
    </div>
  </div>

  <div slot="aside" class="aside">
    <BlogPostsLink heading="Recommended" posts={rankedJson.results || []} />
    <BlogPostsLink heading="Latest posts" posts={latestJson.results || []} />
    <BlogTagsLink heading="Categories" tags={tagsJson || []} />
  </div>
</Layout>
