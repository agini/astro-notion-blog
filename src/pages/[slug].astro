---

import * as interfaces from '../lib/interfaces'
import {
  getPosts,
  getAllPosts,
  getRankedPosts,
  getPostBySlug,
  getPostsByTag,
  getBlock,
  getAllTags,
  getAllBlocksByBlockId,
  downloadFile,
} from '../lib/notion/client'
import {
  getPostLink,
  filePath,
  extractTargetBlocks,
} from '../lib/blog-helpers'
import Layout from '../layouts/Layout.astro'
import PostDate from '../components/PostDate.astro'
import PostTags from '../components/PostTags.astro'
import PostTitle from '../components/PostTitle.astro'
import PostBody from '../components/PostBody.astro'
import PostRelativeLink from '../components/PostRelativeLink.astro'
import BlogPostsLink from '../components/BlogPostsLink.astro'
import BlogTagsLink from '../components/BlogTagsLink.astro'
import styles from '../styles/blog.module.css'

export async function getStaticPaths() {
  const posts = await getAllPosts()
  return posts.map((post: interfaces.Post) => ({ params: { slug: post.Slug } }))
}

const { slug } = Astro.params

const post = await getPostBySlug(slug)
if (!post) {
  throw new Error(`Post not found. slug: ${slug}`)
}

const isPage = post.PageType === 'page'

const blocks = await getAllBlocksByBlockId(post.PageId)

let rankedPosts = []
let recentPosts = []
let tags = []
let postsHavingSameTag = []

if (!isPage) {
  ;[rankedPosts, recentPosts, tags, postsHavingSameTag] =
    await Promise.all([
      getRankedPosts(),
      getPosts(5),
      getAllTags(),
      getPostsByTag(post.Tags[0]?.name, 6),
    ])
}

/// ➤ NEW: Determine OG image for social sharing
let ogImage = ''
if (post.FeaturedImage?.Url) {
  ogImage = new URL(
    filePath(new URL(post.FeaturedImage.Url)),
    Astro.site
  ).toString()
}

const fileAtacchedBlocks = extractTargetBlocks('image', blocks)
  .concat(extractTargetBlocks('file', blocks))
  .filter((block) => {
    if (!block) {
      return false
    }
    const imageOrFile = block.Image || block.File
    return imageOrFile && imageOrFile.File && imageOrFile.File.Url
  })

// Download files
await Promise.all(
  fileAtacchedBlocks
    .map(async (block) => {
      const expiryTime = (block.Image || block.File).File.ExpiryTime
      if (Date.parse(expiryTime) > Date.now()) {
        return Promise.resolve(block)
      }
      return getBlock(block.Id)
    })
    .map((promise) =>
      promise.then((block) => {
        let url!: URL
        try {
          const fileUrl = (block.Image || block.File).File.Url
          // 基準URLを使って絶対URLを作成
          url = new URL(fileUrl, Astro.site)
        } catch (error) {
          console.log(
            'Error with file URL:',
            (block.Image || block.File)?.File?.Url,
            error
          )
          return Promise.reject()
        }
        return Promise.resolve(url)
      })
    )
    .map((promise) => promise.then(downloadFile))
)

let cover: string | undefined

if (post.Cover?.Url) {
  cover = filePath(new URL(post.Cover.Url))
}

const allPosts = isPage ? [] : await getAllPosts()

const currentPostIndex = allPosts.findIndex(
  (p: interfaces.Post) => p.Slug === slug
)
const prevPost = allPosts[currentPostIndex + 1]
const nextPost = allPosts[currentPostIndex - 1]
---

<Layout
  title={post.Title}
  description={post.Excerpt}
  path={getPostLink(post.Slug)}
  ogImage={ogImage}
  noindex={post.PageType === 'page'}
  >

  <div slot="main" class={styles.main}>
      <!-- Display post date and tags -->
      <article class={styles.post}>
        {!isPage && <PostDate post={post} />}
        {!isPage && <PostTags post={post} />}
        <PostTitle post={post} enableLink={false} />
      
      <div class={styles.imageWrapper}>
        <img
          src={post.WorkImage?.Url ?? "/images/no-image.png"}
          alt={post.Title}
          class={styles.workImage}
        />
      </div>
      
      <PostBody blocks={blocks} />
          {!isPage && <PostTags post={post} />}
        {!isPage && (
          <footer>
            <PostRelativeLink prevPost={prevPost} nextPost={nextPost} />
          </footer>
        )}
      </article>
  </div>

  <!-- Sidebar slot -->
  {!isPage && (
    <div slot="aside" class="aside">
      <BlogPostsLink heading="Recommended" posts={rankedPosts} />
      <BlogPostsLink heading="Latest posts" posts={recentPosts} />
      <BlogTagsLink heading="Tags" tags={tags} />
    </div>
  )}
  </div>
</Layout>
